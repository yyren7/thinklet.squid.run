# Beacon 更新频率分析

## 日志输出频率控制

### 代码逻辑

```kotlin
// BeaconScannerManager.kt Line 660-663
if (ibeaconCount % 10 == 0) {
    Log.v(TAG, "🔄 Beacon updated: ...")
}
```

**说明：**
- `ibeaconCount` 是全局计数器，每次收到 iBeacon 信号时递增
- 只有当 `ibeaconCount` 是 10 的倍数时才输出 "Beacon updated" 日志
- **这不是 Beacon 实际更新的频率，只是日志输出的频率**

### 实际更新频率

**Beacon 实际更新频率取决于：**

1. **Beacon 广播间隔**（硬件配置）
   - 您设置的是：**250ms**
   - 即 Beacon 每 0.25 秒广播一次

2. **扫描模式捕获概率**（App 配置）
   - 当前使用：**BALANCED** 模式
   - 扫描窗口：~11.25ms
   - 扫描间隔：~300ms
   - 占空比：~3.75%

3. **实际捕获频率计算**

```
理论捕获概率：
- Beacon 每 250ms 广播一次
- App 每 300ms 扫描 11.25ms
- 扫描窗口占空比：11.25ms / 300ms ≈ 3.75%

实际捕获情况：
- 由于时间对齐问题，不是每次广播都能捕获
- 平均捕获间隔：约 2-5 秒（取决于时间对齐）
- 如果看到 20 秒一次日志，说明：
  * 平均每 2 秒收到一次信号（20秒 / 10次 = 2秒/次）
  * 这是 BALANCED 模式的正常表现 ✅
```

## 20 秒一次日志是否正常？

### ✅ **完全正常！**

**分析：**
- 20 秒输出一次 "Beacon updated" 日志
- 说明在这 20 秒内收到了 **10 次** iBeacon 信号
- 平均每 **2 秒**收到一次信号
- 对于 BALANCED 模式来说，这是**合理的频率**

### 频率对比

| 扫描模式 | 理论捕获频率 | 实际观察频率 | 日志输出频率（每10次） |
|---------|------------|------------|---------------------|
| **LOW_LATENCY** | 几乎每次（250ms） | 每 0.25-0.5 秒 | 每 2.5-5 秒 |
| **BALANCED** ⭐ | 约 1/26 次 | 每 2-5 秒 | 每 20-50 秒 |
| **LOW_POWER** | 约 1/180 次 | 每 10-30 秒 | 每 100-300 秒 |

**您的观察：**
- 20 秒一次日志 = 每 2 秒收到一次信号
- 符合 BALANCED 模式的预期 ✅

## 影响更新频率的因素

### 1. Beacon 硬件配置

**广播间隔（Adv interval）：**
- 当前：250ms
- 如果改为 500ms → 捕获频率减半
- 如果改为 100ms → 捕获频率增加（但功耗增加）

### 2. 扫描模式

**BALANCED 模式（当前）：**
```
扫描窗口：11.25ms
扫描间隔：300ms
占空比：3.75%

捕获概率：
- 理论上每 300ms 扫描窗口内可能捕获到 1-2 次广播
- 但由于时间对齐，实际捕获间隔约 2-5 秒
```

**如果想提高捕获频率：**
- 改为 LOW_LATENCY：捕获频率提高 26 倍，但功耗增加 26 倍
- 保持 BALANCED：当前频率已足够（每 2 秒一次）

### 3. 环境因素

**信号干扰：**
- WiFi、其他 BLE 设备可能干扰
- 金属障碍物、人体遮挡可能影响信号

**距离：**
- 距离越远，信号越弱，捕获概率越低
- 距离越近，信号越强，捕获概率越高

## 实际更新 vs. 日志输出

### 重要区别

**实际更新频率：**
- BeaconScannerManager 内部每收到一次信号就更新 `discoveredBeacons`
- 这个更新是**实时的**，不受日志输出控制

**日志输出频率：**
- 每 10 次更新才输出一次日志（`ibeaconCount % 10 == 0`）
- 这只是为了**减少日志量**，不影响实际功能

### 数据流

```
Beacon 广播（每 250ms）
    ↓
BALANCED 扫描捕获（每 2-5 秒捕获一次）
    ↓
handleBeaconDiscovered() 被调用
    ↓
ibeaconCount++（每次递增）
    ↓
更新 discoveredBeacons（实时更新）✅
    ↓
if (ibeaconCount % 10 == 0) {
    输出日志 "Beacon updated"（每 10 次输出一次）
}
```

## 如何验证实际更新频率

### 方法 1：查看详细日志

```bash
# 查看所有 iBeacon 检测日志（前 20 次）
adb logcat | grep "iBeacon detected"

# 查看所有 Beacon 更新（包括未输出的）
# 需要修改代码，临时移除 % 10 的限制
```

### 方法 2：添加调试日志

临时修改代码查看实际频率：

```kotlin
// BeaconScannerManager.kt Line 654-664
} else {
    // Update existing Beacon
    discoveredBeacons[beaconKey] = filteredBeaconData
    
    // 临时：每次更新都输出（用于调试）
    Log.d(TAG, "🔄 Beacon updated (count=$ibeaconCount): UUID=${beaconData.uuid}, distance=${String.format("%.2f", filteredDistance)}m")
    
    // 原代码：每 10 次输出一次
    // if (ibeaconCount % 10 == 0) {
    //     Log.v(TAG, "🔄 Beacon updated: ...")
    // }
}
```

### 方法 3：通过 GeofenceManager 日志

```bash
# 查看围栏数据更新（每 10 秒同步一次）
adb logcat | grep "Updated geofence data"
```

## 优化建议

### 当前配置评估

**您的配置：**
- Beacon 广播间隔：250ms ✅ 合理
- 扫描模式：BALANCED ✅ 功耗和性能平衡
- 捕获频率：每 2 秒一次 ✅ 足够用于围栏监控
- 日志输出：每 20 秒一次 ✅ 减少日志量

**结论：当前配置完全正常，无需调整！** ✅

### 如果需要更频繁的更新

**场景 1：需要更快的响应**
```kotlin
// 改为 LOW_LATENCY（功耗增加 26 倍）
.setScanMode(ScanSettings.SCAN_MODE_LOW_LATENCY)
```
- 捕获频率：每 0.25-0.5 秒
- 日志输出：每 2.5-5 秒
- 功耗：增加 26 倍

**场景 2：需要更频繁的日志（调试）**
```kotlin
// 改为每 5 次输出一次
if (ibeaconCount % 5 == 0) {
    Log.v(TAG, "🔄 Beacon updated: ...")
}
```
- 日志输出：每 10 秒（假设每 2 秒捕获一次）
- 不影响功能，只是日志更详细

**场景 3：降低日志频率（生产环境）**
```kotlin
// 改为每 50 次输出一次
if (ibeaconCount % 50 == 0) {
    Log.v(TAG, "🔄 Beacon updated: ...")
}
```
- 日志输出：每 100 秒（假设每 2 秒捕获一次）
- 进一步减少日志量

## 常见问题

### Q1: 为什么日志是 20 秒一次，而不是更频繁？

**A:** 因为代码设置了 `ibeaconCount % 10 == 0`，每 10 次更新才输出一次日志。实际更新频率是每 2 秒一次，所以日志是 20 秒一次。

### Q2: 20 秒一次是否太慢了？

**A:** 不是！这是**日志输出频率**，不是实际更新频率。实际 Beacon 数据每 2 秒更新一次，对于围栏监控来说完全足够。

### Q3: 如何提高实际更新频率？

**A:** 
1. 改为 LOW_LATENCY 扫描模式（功耗增加）
2. 缩短 Beacon 广播间隔（硬件配置，功耗增加）
3. 当前 BALANCED 模式已经足够，不建议改动

### Q4: 日志频率和功能有关系吗？

**A:** 没有！日志只是用于调试和监控。实际功能（围栏检测、距离计算）使用的是实时更新的数据，不受日志输出频率影响。

## 总结

### ✅ 20 秒一次日志是正常的

**原因：**
1. Beacon 实际更新频率：每 2 秒一次（正常）
2. 日志输出频率：每 10 次更新输出一次 = 20 秒（正常）
3. BALANCED 模式的预期表现：每 2-5 秒捕获一次（正常）

### 📊 频率指标

| 指标 | 当前值 | 是否正常 |
|------|--------|---------|
| Beacon 广播间隔 | 250ms | ✅ |
| 实际捕获频率 | 每 2 秒 | ✅ BALANCED 模式正常 |
| 日志输出频率 | 每 20 秒 | ✅ 每 10 次输出一次 |
| 围栏数据同步 | 每 10 秒 | ✅ GeofenceManager 同步 |
| 超时检测 | 60 秒 | ✅ 足够检测信号丢失 |

### 🎯 建议

**当前配置无需调整！**
- 功能正常：围栏检测、距离计算都正常
- 功耗合理：BALANCED 模式功耗低
- 响应及时：每 2 秒更新一次，足够用于围栏监控

**如果确实需要更频繁的日志（仅用于调试）：**
- 可以临时修改 `ibeaconCount % 10` 为 `ibeaconCount % 5` 或 `ibeaconCount % 1`
- 调试完成后恢复原设置

---

**文档版本**: 1.0  
**最后更新**: 2025-11-13  
**作者**: Thinklet Development Team





