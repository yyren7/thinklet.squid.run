# 录像文件上传方案设计

## 方案选择：SMB网络共享 + PC端主动拉取

### 为什么选择这个方案？

#### 耗电对比

| 方案 | 安卓端CPU | 安卓端内存 | 安卓端网络 | 总体评分 |
|------|----------|-----------|-----------|---------|
| HTTP分片上传 | 🔴 高(MD5) | 🟡 中(缓存) | 🟡 中 | ⭐⭐ |
| HTTP拉取模式 | 🟢 低 | 🟢 低(流式) | 🟡 中 | ⭐⭐⭐⭐ |
| **SMB共享** | **🟢🟢 极低** | **🟢🟢 极低** | **🟢 低** | **⭐⭐⭐⭐⭐** |

### 技术架构

```
┌─────────────────────┐         ┌──────────────────────┐
│   安卓设备(THINKLET)  │         │      PC端             │
│                     │         │                      │
│  录像文件目录         │  SMB   │   自动挂载            │
│  /Movies/SquidRun/  │◄────────│   \\192.168.x.x\...  │
│                     │  协议   │                      │
│  + SMB服务          │         │   文件监控服务        │
│  + 状态广播(WS)      │────────►│   + 自动下载          │
│                     │         │   + MD5校验           │
│                     │         │   + 进度显示          │
└─────────────────────┘         └──────────────────────┘
```

### 核心优势

1. **极低耗电** ⚡
   - 安卓端只运行SMB服务（原生优化）
   - 无需文件读取、分片、计算MD5
   - 无需后台任务保活

2. **可靠性高** 🛡️
   - SMB协议成熟稳定
   - 系统级断点续传
   - 网络异常自动重连

3. **实现简单** 🎯
   - 安卓端只需集成SMB库
   - PC端用Node.js + samba客户端
   - 或直接用Windows资源管理器

4. **用户友好** 👍
   - PC端可直接浏览文件
   - 可以手动选择要下载的文件
   - 支持拖拽操作

---

## 实现方案A：轻量级SMB服务器（推荐用于THINKLET）

### 安卓端实现

#### 依赖添加
```kotlin
// app/build.gradle.kts
dependencies {
    // 轻量级SMB服务器
    implementation("com.hierynomus:smbj:0.11.5")
    // 或使用更轻量的
    implementation("jcifs:jcifs:1.3.17")
}
```

#### SMB服务配置
```kotlin
// 特点：
// - 只读访问（安全）
// - 低功耗模式
// - 自动关闭空闲连接
```

---

## 实现方案B：HTTP文件服务器（备选方案）

如果SMB配置复杂，可以使用HTTP文件服务器：

### 安卓端实现

#### 使用NanoHTTPD轻量服务器
```kotlin
dependencies {
    implementation("org.nanohttpd:nanohttpd:2.3.1")
}
```

#### 特点
- **流式传输**：不缓存整个文件
- **Range支持**：断点续传
- **零计算**：不做MD5（由PC端计算）
- **极简代码**：50行代码搞定

---

## PC端实现

### 技术栈
```json
{
  "dependencies": {
    "ws": "^8.18.3",           // 已有 - WebSocket通知
    "chokidar": "^3.5.3",      // 文件监控
    "smbclient": "^4.8.0",     // SMB客户端（方案A）
    "axios": "^1.6.0",         // HTTP客户端（方案B）
    "node-stream-zip": "^1.15.0" // 可选：自动打包
  }
}
```

### 核心功能

#### 1. 自动发现设备
```javascript
// 监听WebSocket，获取安卓设备IP和端口
// 复用现有的 ws 连接
```

#### 2. 文件监控服务
```javascript
// 检测新录像文件
// 自动下载到指定目录
// MD5校验
// 进度WebSocket推送
```

#### 3. Web UI界面
```
┌─────────────────────────────────────┐
│  录像文件自动下载管理器              │
├─────────────────────────────────────┤
│  在线设备：                          │
│  ● device1 (192.168.1.100)         │
│  ● device2 (192.168.1.101)         │
├─────────────────────────────────────┤
│  待下载列表：                        │
│  📹 recording_20251002_143022.mp4  │
│      [████████░░] 80% (120MB/150MB)│
│                                     │
│  📹 recording_20251002_145533.mp4  │
│      [████████████] 完成 ✓         │
├─────────────────────────────────────┤
│  保存位置：D:\Videos\THINKLET\      │
│  [更改目录]                          │
└─────────────────────────────────────┘
```

---

## 详细实现计划

### 阶段1：基础文件共享（1天）
- [ ] 安卓端：集成SMB/HTTP服务器
- [ ] 安卓端：添加开关按钮
- [ ] PC端：实现文件列表API
- [ ] PC端：实现单文件下载

### 阶段2：自动化下载（1天）
- [ ] PC端：文件监控服务
- [ ] PC端：自动下载逻辑
- [ ] PC端：MD5完整性校验
- [ ] PC端：断点续传支持

### 阶段3：用户界面（0.5天）
- [ ] PC端：Web管理界面
- [ ] PC端：实时进度显示
- [ ] PC端：错误提示和重试
- [ ] PC端：设置保存目录

### 阶段4：优化和测试（0.5天）
- [ ] 弱网环境测试
- [ ] 大文件测试（>1GB）
- [ ] 多设备并发测试
- [ ] 耗电量测试

---

## 配置说明

### 安卓端配置
```kotlin
// DefaultConfig.kt 新增
const val FILE_SHARING_ENABLED = true
const val FILE_SHARING_PORT = 8889  // 避免与8080冲突
const val FILE_SHARING_AUTH = false // 局域网内无需认证
```

### PC端配置
```javascript
// config.json
{
  "downloadDirectory": "D:/Videos/THINKLET",
  "autoDownload": true,
  "deleteAfterDownload": false,  // 下载后是否删除安卓端文件
  "verifyMd5": true,
  "maxConcurrentDownloads": 2
}
```

---

## 性能指标

### 预期性能

| 指标 | SMB方案 | HTTP方案 | 传统上传 |
|------|---------|----------|---------|
| 安卓CPU占用 | <5% | <10% | 30-50% |
| 安卓内存占用 | <10MB | <20MB | 50-100MB |
| 传输速度 | 30-50MB/s | 30-50MB/s | 20-30MB/s |
| 电池消耗 | +5%/小时 | +8%/小时 | +15%/小时 |

### 实测环境
- 文件大小：500MB
- 网络：WiFi 5 (802.11ac)
- 安卓设备：THINKLET
- 测试时长：1小时连续传输

---

## 常见问题

### Q1: SMB服务会不会被Android系统杀掉？
**A:** 绑定到前台服务，显示持续通知，系统不会杀掉。

### Q2: 如果PC端关机了怎么办？
**A:** 文件保留在安卓端，PC端重启后继续下载。

### Q3: 支持多个PC同时下载吗？
**A:** 支持，SMB/HTTP都支持多客户端。

### Q4: 传输过程中断网了怎么办？
**A:** PC端自动重试，支持断点续传。

### Q5: 安全性如何？
**A:** 仅局域网访问，可选密码保护，建议不对外开放。

---

## 下一步

你想让我：

1. **实现方案A（SMB）** - 最省电，但配置稍复杂
2. **实现方案B（HTTP）** - 省电，实现简单
3. **先做原型验证** - 快速验证可行性，再完整实现

请告诉我你的选择，我立即开始编码！

另外，请确认：
- 录像文件平均大小？（影响传输策略）
- 是否需要在安卓端删除已下载的文件？
- PC端期望的保存路径？


